import logging
import asyncio
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import Application, CommandHandler, ContextTypes

# ØªÙ†Ø¸ÛŒÙ… Ù„Ø§Ú¯
logging.basicConfig(format='%(asctime)s - %(name)s - %(levelname)s - %(message)s', level=logging.INFO)
logger = logging.getLogger(__name__)

# ØªÙˆÚ©Ù† Ùˆ Ø¢Ø¯Ø±Ø³ ÙˆØ¨â€ŒÙ‡ÙˆÚ©
TOKEN = '8045348833:AAEZDh60grBIHTz5mOUYEHK7ZLEV7B2npTc'
WEBHOOK_URL = "https://chat-bot-9v1s.onrender.com/webhook"

# ØªØ§Ø¨Ø¹ ØªÙ…ÛŒØ² Ú©Ø±Ø¯Ù† Ù…ØªÙ† Ø¨Ø±Ø§ÛŒ MarkdownV2
def clean_text(text):
    if not text:
        return ""
    reserved_chars = r"([_*[\]()~`>#+\-=|{}.!])"
    return re.sub(reserved_chars, r"\\\1", text)

# ØªØ§Ø¨Ø¹ Ø¯Ø³ØªÙˆØ± /start
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    logger.info(f"Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø³ØªÙˆØ± /start Ø§Ø² Ú©Ø§Ø±Ø¨Ø± {user_id}")
    user_name = update.message.from_user.first_name
    welcome_message = clean_text(
        f"Ø³Ù„Ø§Ù… {user_name}!\nØ¨Ù‡ PlatoDex Ø®ÙˆØ´ Ø§ÙˆÙ…Ø¯ÛŒ - Ù…Ø±Ú©Ø² Ø¨Ø§Ø²ÛŒâ€ŒÙ‡Ø§ÛŒ Plato!\n"
        "â€¢ Ú†Øª Ø¨Ø§ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ ğŸ¤–\nâ€¢ ØªÙˆÙ„ÛŒØ¯ ØªØµÙˆÛŒØ± ğŸ–¼ï¸"
    )
    keyboard = [
        [InlineKeyboardButton("Run App ğŸ“±", web_app={"url": "https://platodex-tde3qe.vercel.app/"})],
        [InlineKeyboardButton("Chat with AI ğŸ¤–", callback_data="chat_with_ai")],
        [InlineKeyboardButton("Generate Image ğŸ–¼ï¸", callback_data="generate_image")]
    ]
    await update.message.reply_text(
        welcome_message,
        reply_markup=InlineKeyboardMarkup(keyboard),
        parse_mode="MarkdownV2"
    )

# ØªØ§Ø¨Ø¹ Ø§ØµÙ„ÛŒ Ø¨Ø±Ø§ÛŒ Ø§Ø¬Ø±Ø§ÛŒ Ø±Ø¨Ø§Øª
def main():
    # Ø³Ø§Ø®Øª Application
    application = Application.builder().token(TOKEN).read_timeout(60).write_timeout(60).connect_timeout(60).build()

    # Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Handler Ø¨Ø±Ø§ÛŒ Ø¯Ø³ØªÙˆØ± /start
    application.add_handler(CommandHandler("start", start))

    # Ø§Ø¬Ø±Ø§ÛŒ Ø±Ø¨Ø§Øª Ø¨Ø§ ÙˆØ¨â€ŒÙ‡ÙˆÚ©
    application.run_webhook(
        listen="0.0.0.0",
        port=8000,
        url_path="/webhook",
        webhook_url=WEBHOOK_URL
    )

if __name__ == "__main__":
    main()
